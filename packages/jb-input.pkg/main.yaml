package:
  description: Jointbox Input Module
  author: Jointbox Team <support@jointbox.org>
  license: MIT
  tags: [ jointbox, jb-module ]
  params:
    address:
      required: true
      validator: mcp23017_address
    timing:
      required: true
      default: { }
      validator:
        name: package_params
        args:
          debounce_interval:
            default: 0.2s
            validator: time_period
          multiclick_cooldown:
            default: 0.5s
            validator: time_period

  variables:
    hub_id: "{{ pkg.instance_name }}_hub"
    single_click_timing:
      - ON for at most 0.8s
      - OFF for at least 0.1s
    long_press_timing:
      - ON for at least 1.2s
    double_click_timing:
      - ON for at most 1s
      - OFF for at most 0.3s
      - ON for at most 1s
      - OFF for at least 0.2s

  macros:
    switch:
      params:
        name:
          validator: string
        input_num:
          validator:
            name: int_range
            args: { min: 0, max: 15 }
        expose:
          default: false
          validator: boolean
        on_click:
          required: false
          validator: actions_with_fallback
        on_long_press:
          required: false
          validator: actions_with_fallback
        on_double_click:
          required: false
          validator: actions_with_fallback
      body:
        platform: gpio
        internal: "{{ not macro.params.expose }}"
        name: "{{ macro.params.name }}"
        pin:
          pcf8574: "{{ var.hub_id }}"
          number: "{{ macro.params.input_num }}"
          inverted: true
        on_multi_click:
          - ~if: "macro.params.on_click is defined"
            timing: "{{ var.single_click_timing }}"
            invalid_cooldown: "{{ pkg.params.timing.multiclick_cooldown }}"
            then:
              ~macro: "jbstd.macros.action_with_fallback"
              default_action: "{{ macro.params.on_click.default }}"
              fallback_action: "{{ macro.params.on_click.when_online }}"
          - ~if: "macro.params.on_long_press is defined"
            timing: "{{ var.long_press_timing }}"
            invalid_cooldown: "{{ pkg.params.timing.multiclick_cooldown }}"
            then:
              ~macro: "jbstd.macros.action_with_fallback"
              default_action: "{{ macro.params.on_long_press.default }}"
              fallback_action: "{{ macro.params.on_long_press.when_online }}"
    reed:
      params:
        name:
          validator: string
        device_class:
          default: door
          validator:
            name: one_of
            args: [ door, window ]
        input_num:
          validator:
            name: int_range
            args: { min: 0, max: 15 }
        expose:
          default: true
          validator: boolean
        on_opened:
          required: false
          validator: actions_with_fallback
        on_closed:
          required: false
          validator: actions_with_fallback
      body:
        platform: gpio
        device_class: "{{ macro.params.device_class }}"
        internal: "{{ not macro.params.expose }}"
        name: "{{ macro.params.name }}"
        pin:
          pcf8574: "{{ var.hub_id }}"
          number: "{{ macro.params.input_num }}"
          inverted: true
        filters:
          - invert:
          - delayed_on_off: "{{ pkg.params.debounce_interval }}"
        on_release: # -> on close
          - ~if: "macro.params.on_closed is defined"
            then:
              ~macro: "jbstd.macros.action_with_fallback"
              default_action: "{{ macro.params.on_closed.default }}"
              fallback_action: "{{ macro.params.on_closed.when_online }}"
        on_press: # -> on open
          - ~if: "macro.params.on_opened is defined"
            then:
              ~macro: "jbstd.macros.action_with_fallback"
              default_action: "{{ macro.params.on_opened.default }}"
              fallback_action: "{{ macro.params.on_opened.when_online }}"

  export: [ hub_id, single_click_timing, long_press_timing, double_click_timing ]
mcp23017:
  - id: '{{ var.hub_id }}'
    address: '{{ pkg.params.address }}'
